import { Component, Input, Output, EventEmitter, ViewChild, ViewChildren, QueryList, ChangeDetectionStrategy } from '@angular/core';
import { from, distinctUntilChanged, fromEvent, mergeMap, startWith, EMPTY, Observable, Subject, animationFrameScheduler } from 'rxjs';
import { tap, debounceTime, filter, takeUntil, switchMap } from 'rxjs/operators';
import { SlidingDirection } from '../models/constants';
import { HorizontalAdapter, VerticalAdapter } from './adapters';
import { resizeObservable } from '../utils/resize-observer';
import { GalleryItemComponent } from './gallery-item.component';
import * as i0 from "@angular/core";
import * as i1 from "@angular/cdk/platform";
import * as i2 from "../smooth-scroll";
import * as i3 from "../services/gallery.service";
import * as i4 from "@angular/common";
import * as i5 from "./gallery-item.component";
export class GallerySliderComponent {
    constructor(_el, _cd, _zone, _platform, _smoothScroll, _gallery) {
        this._el = _el;
        this._cd = _cd;
        this._zone = _zone;
        this._platform = _platform;
        this._smoothScroll = _smoothScroll;
        this._gallery = _gallery;
        this.scrollHandler$ = new Subject();
        this.visibleElements = new Map();
        this._destroyed$ = new Subject();
        /** Stream that emits when item is clicked */
        this.itemClick = new EventEmitter();
        /** Stream that emits when an error occurs */
        this.error = new EventEmitter();
        this.items = new QueryList();
        this.scrollHandler$.pipe(debounceTime(0, animationFrameScheduler), switchMap(({ value, behavior }) => {
            this._gallery.debugConsole('[Gallery scrollHandler$] ', this.slider.style.scrollSnapType);
            this.slider.style.scrollSnapType = 'unset';
            const el = this.items.get(value)?.element;
            this._gallery.debugConsole('🤯 [Gallery scrollHandler$] scrollSnapType = unset, scrollTo element', !!el);
            if (el) {
                this.slider.classList.add('g-scrolling');
                const pos = this.adapter.getScrollToValue(el, behavior || this.config.scrollBehavior);
                const index = +this.items.get(value)?.element.getAttribute('galleryIndex');
                this._gallery.debugConsole(`🚀 [Gallery scrollHandler$] Scroll start ===> index: ${index}, position:`, pos);
                this._gallery.debugConsole(`🚀 [Gallery scrollHandler$] slider scrollable`, this.adapter.scrollValue);
                return from(this._smoothScroll.scrollTo(this.slider, pos)).pipe(tap(() => {
                    // Reset viewport properties on scroll end
                    this._isPanning = false;
                    this.slider.classList.remove('g-scrolling');
                    this.slider.style.scrollSnapType = this.adapter.scrollSnapType;
                    this._gallery.debugConsole('✅ [Gallery scrollHandler$] Scroll end');
                }));
            }
            this._gallery.debugConsole('😡 [Gallery scrollHandler$] Scroll element was not found!');
            return EMPTY;
        }), takeUntil(this._destroyed$)).subscribe();
    }
    get slider() {
        return this.sliderEl.nativeElement;
    }
    ngOnChanges(changes) {
        if (changes.config) {
            if (changes.config.currentValue?.slidingDirection !== changes.config.previousValue?.slidingDirection) {
                switch (this.config.slidingDirection) {
                    case SlidingDirection.Horizontal:
                        this.adapter = new HorizontalAdapter(this.slider, this.config);
                        break;
                    case SlidingDirection.Vertical:
                        this.adapter = new VerticalAdapter(this.slider, this.config);
                        break;
                }
                if (!changes.config.firstChange) {
                    requestAnimationFrame(() => {
                        // Keep the correct sliding position when direction changes
                        this.scrollToIndex(this.state.currIndex, 'auto');
                    });
                }
                // Reactivate gestures
                this.enableDisableGestures();
            }
            if (!changes.config.firstChange) {
                if (changes.config.currentValue?.mouseSlidingDisabled !== changes.config.previousValue?.mouseSlidingDisabled) {
                    this.enableDisableGestures();
                }
            }
        }
        // Scroll to current index
        if (changes.state && changes.state.currentValue?.currIndex !== changes.state.previousValue?.currIndex) {
            requestAnimationFrame(() => {
                this.scrollToIndex(this.state.currIndex, changes.state.firstChange ? 'auto' : this.state.behavior);
            });
        }
    }
    ngOnInit() {
        this._zone.runOutsideAngular(() => {
            // We need to set the visibleElements in the viewport using intersection observer
            this.createIntersectionObserver(this.slider).pipe(tap((entry) => {
                entry.target.classList.toggle('g-item-visible', entry.isIntersecting);
                if (entry.isIntersecting) {
                    this.visibleElements.set(entry.target, entry);
                }
                else {
                    this.visibleElements.delete(entry.target);
                }
            }), takeUntil(this._destroyed$)).subscribe();
            // Subscribe to slider scroll event
            fromEvent(this.slider, 'scroll', { passive: true }).pipe(debounceTime(50), filter(() => !this._isPanning), tap(() => this.onViewportScroll()), takeUntil(this._destroyed$)).subscribe();
            // Detect if the size of the slider has changed detecting current index on scroll
            if (this._platform.isBrowser) {
                resizeObservable(this._el.nativeElement).pipe(debounceTime(this.config.resizeDebounceTime), tap(([entry]) => this.onHostResize(entry)), takeUntil(this._destroyed$)).subscribe();
            }
        });
    }
    ngAfterViewInit() {
        this.items.notifyOnChanges();
        this.items.changes.pipe(startWith(null), tap(() => {
            // Disconnect all and reconnect later
            this.visibleElements.forEach((item) => {
                this.intersectionObserver.unobserve(item.target);
            });
            // Connect with the new items
            this.items.toArray().map((item) => {
                this.intersectionObserver.observe(item.element);
            });
        }), takeUntil(this._destroyed$)).subscribe();
    }
    ngAfterViewChecked() {
        if (this.config.itemAutosize) {
            this.slider.style.setProperty('--slider-centralize-start-size', this.adapter.getCentralizerStartSize() + 'px');
            this.slider.style.setProperty('--slider-centralize-end-size', this.adapter.getCentralizerEndSize() + 'px');
        }
    }
    ngOnDestroy() {
        this._destroyed$.next();
        this._destroyed$.complete();
        this.deactivateGestures();
    }
    trackByFn(index, item) {
        return item.type;
    }
    onHostResize(entry) {
        const width = Math.ceil(entry.contentRect.width);
        const height = Math.ceil(entry.contentRect.height);
        this.slider.style.width = `${width}px`;
        this.slider.style.height = `${height}px`;
        this.scrollToIndex(this.state.currIndex, 'auto');
        // Detect changes on gallery-item components to re-calculate item size
        this._cd.detectChanges();
        this._gallery.debugConsole('🦐 [Gallery OnHostResize]: set viewport width to absolute number');
    }
    onViewportScroll() {
        // Check if scrolled item is great enough to navigate
        const currElement = this.items.get(this.state.currIndex)?.element;
        const elementAtCenter = this.getElementFromViewportCenter();
        if (elementAtCenter) {
            // Check if the gallery-item element is not the active element
            if (elementAtCenter !== currElement) {
                this.tryScrollToElement(elementAtCenter);
            }
        }
        else {
            this._gallery.debugConsole('⁉ [Gallery onViewportScroll]: No center element was found');
            this.visibleElements.forEach((entry) => {
                this.tryScrollToElement(entry.target);
            });
        }
    }
    tryScrollToElement(elementAtCenter) {
        const allowedMargin = 10;
        const offsetDiff = (this.adapter.clientSize - this.adapter.getClientSize(elementAtCenter)) / 2;
        const rangeStart = this.adapter.scrollValue + offsetDiff;
        const rangeEnd = this.adapter.scrollValue + this.adapter.clientSize - offsetDiff;
        const elStart = this.adapter.getOffsetSize(elementAtCenter);
        const elEnd = elStart + this.adapter.getClientSize(elementAtCenter);
        const isStart = rangeStart + allowedMargin >= elStart && rangeStart - allowedMargin <= elStart;
        const isEnd = rangeEnd + allowedMargin >= elEnd && rangeEnd - allowedMargin <= elEnd;
        // Reset position
        this.slider.style.scrollSnapType = this.adapter.scrollSnapType;
        // Check if element is within the detection range
        if (isStart && isEnd) {
            // If element is within the range set it as the active gallery item
            this._gallery.debugConsole('🍄 [Gallery onViewportScroll]: Set active gallery item');
            const index = +elementAtCenter.getAttribute('galleryIndex');
            this._zone.run(() => this._gallery.ref(this.galleryId).set(index, 'smooth'));
        }
    }
    scrollToIndex(value, behavior, onEnd) {
        this.scrollHandler$.next({ value, behavior, onEnd });
    }
    enableDisableGestures() {
        // Enable/Disable mouse sliding on desktop browser only
        if (!this._platform.IOS && !this._platform.ANDROID) {
            if (!this.config.mouseSlidingDisabled) {
                this.activateGestures();
            }
            else {
                this.deactivateGestures();
            }
        }
    }
    activateGestures() {
        if (typeof Hammer !== 'undefined') {
            // Destroy hammer if a previous instance was created
            this.deactivateGestures();
            const direction = this.adapter.panDirection;
            // Activate gestures
            this._zone.runOutsideAngular(() => {
                this._hammer = new Hammer(this._el.nativeElement, { inputClass: Hammer.MouseInput });
                this._hammer.get('pan').set({ direction });
                let panOffset;
                // Set panOffset for sliding on pan start event
                this._hammer.on('panstart', () => {
                    this._smoothScroll.dismissOngoingScroll(this.slider);
                    panOffset = this.adapter.scrollValue;
                    // Disable scroll-snap-type functionality
                    this.slider.style.scrollSnapType = 'unset';
                    this.slider.classList.add('g-sliding');
                    this._isPanning = true;
                });
                this._hammer.on('panmove', (e) => this.slider.scrollTo(this.adapter.getPanValue(panOffset, e, 'auto')));
                this._hammer.on('panend', (e) => this.onPanEnd(e));
            });
        }
    }
    deactivateGestures() {
        this._hammer?.destroy();
    }
    onPanEnd(e) {
        this._gallery.debugConsole('🖱️ [Gallery]: onPanEnd', e);
        this.slider.classList.remove('g-sliding');
        const delta = this.adapter.getPanDelta(e);
        const velocity = this.adapter.getPanVelocity(e);
        const galleryRef = this._gallery.ref(this.galleryId);
        this._zone.run(() => {
            // Check if scrolled item is great enough to navigate
            const currElement = this.items.get(this.state.currIndex)?.element;
            // Find the gallery item element in the center elements
            const elementAtCenter = this.getElementFromViewportCenter();
            // Check if center item can be taken from element using
            if (elementAtCenter && elementAtCenter !== currElement) {
                const index = +elementAtCenter.getAttribute('galleryIndex');
                this.scrollToIndex(index, 'smooth');
                return;
            }
            // Check if delta is great enough to navigate
            if (Math.abs(delta) > (currElement.clientWidth || this.adapter.clientSize) / 2) {
                return delta > 0 ? galleryRef.prev('smooth', false) : galleryRef.next('smooth', false);
            }
            // Check if velocity is great enough to navigate
            if (Math.abs(velocity) > 0.3) {
                return velocity > 0 ? galleryRef.prev('smooth', false) : galleryRef.next('smooth', false);
            }
            // Reset position to the current index
            this.scrollToIndex(this.state.currIndex, 'smooth');
        });
    }
    getElementFromViewportCenter() {
        // Get slider position relative to the document
        const sliderRect = this.slider.getBoundingClientRect();
        // Try look for the center item using `elementsFromPoint` function
        const centerElements = document.elementsFromPoint(sliderRect.x + (sliderRect.width / 2), sliderRect.y + (sliderRect.height / 2));
        // Find the gallery item element in the center elements
        const element = centerElements.find((element) => element.localName === 'gallery-item' && element.getAttribute('galleryId') === this.galleryId);
        this._gallery.debugConsole('🪟 [Gallery]: getElementFromViewportCenter', element);
        return element;
    }
    createIntersectionObserver(slider) {
        return new Observable((observer) => {
            this.intersectionObserver = new IntersectionObserver((entries) => observer.next(entries), { root: slider });
            return () => this.intersectionObserver.disconnect();
        }).pipe(mergeMap((entries) => entries), distinctUntilChanged());
    }
}
GallerySliderComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.0.3", ngImport: i0, type: GallerySliderComponent, deps: [{ token: i0.ElementRef }, { token: i0.ChangeDetectorRef }, { token: i0.NgZone }, { token: i1.Platform }, { token: i2.SmoothScrollManager }, { token: i3.Gallery }], target: i0.ɵɵFactoryTarget.Component });
GallerySliderComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "15.0.3", type: GallerySliderComponent, selector: "gallery-slider", inputs: { galleryId: "galleryId", state: "state", config: "config" }, outputs: { itemClick: "itemClick", error: "error" }, viewQueries: [{ propertyName: "sliderEl", first: true, predicate: ["slider"], descendants: true, static: true }, { propertyName: "items", predicate: GalleryItemComponent, descendants: true }], usesOnChanges: true, ngImport: i0, template: `
    <div #slider
         class="g-slider"
         [attr.centralised]="config.itemAutosize">
      <div class="g-slider-content">
        <gallery-item *ngFor="let item of state.items; trackBy: trackByFn; index as i"
                      [attr.galleryId]="galleryId"
                      [type]="item.type"
                      [config]="config"
                      [data]="item.data"
                      [currIndex]="state.currIndex"
                      [index]="i"
                      (click)="itemClick.emit(i)"
                      (error)="error.emit({ itemIndex: i, error: $event })">
        </gallery-item>
      </div>
    </div>
    <ng-content></ng-content>
  `, isInline: true, dependencies: [{ kind: "directive", type: i4.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { kind: "component", type: i5.GalleryItemComponent, selector: "gallery-item", inputs: ["config", "index", "currIndex", "type", "data"], outputs: ["error"] }], changeDetection: i0.ChangeDetectionStrategy.OnPush });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.0.3", ngImport: i0, type: GallerySliderComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'gallery-slider',
                    changeDetection: ChangeDetectionStrategy.OnPush,
                    template: `
    <div #slider
         class="g-slider"
         [attr.centralised]="config.itemAutosize">
      <div class="g-slider-content">
        <gallery-item *ngFor="let item of state.items; trackBy: trackByFn; index as i"
                      [attr.galleryId]="galleryId"
                      [type]="item.type"
                      [config]="config"
                      [data]="item.data"
                      [currIndex]="state.currIndex"
                      [index]="i"
                      (click)="itemClick.emit(i)"
                      (error)="error.emit({ itemIndex: i, error: $event })">
        </gallery-item>
      </div>
    </div>
    <ng-content></ng-content>
  `
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: i0.ChangeDetectorRef }, { type: i0.NgZone }, { type: i1.Platform }, { type: i2.SmoothScrollManager }, { type: i3.Gallery }]; }, propDecorators: { galleryId: [{
                type: Input
            }], state: [{
                type: Input
            }], config: [{
                type: Input
            }], itemClick: [{
                type: Output
            }], error: [{
                type: Output
            }], sliderEl: [{
                type: ViewChild,
                args: ['slider', { static: true }]
            }], items: [{
                type: ViewChildren,
                args: [GalleryItemComponent]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2FsbGVyeS1zbGlkZXIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmctZ2FsbGVyeS9zcmMvbGliL2NvbXBvbmVudHMvZ2FsbGVyeS1zbGlkZXIuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsS0FBSyxFQUNMLE1BQU0sRUFDTixZQUFZLEVBTVosU0FBUyxFQUNULFlBQVksRUFJWixTQUFTLEVBRVQsdUJBQXVCLEVBQ3hCLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFDTCxJQUFJLEVBQ0osb0JBQW9CLEVBQ3BCLFNBQVMsRUFDVCxRQUFRLEVBQ1IsU0FBUyxFQUNULEtBQUssRUFDTCxVQUFVLEVBQ1YsT0FBTyxFQUVQLHVCQUF1QixFQUN4QixNQUFNLE1BQU0sQ0FBQztBQUNkLE9BQU8sRUFBRSxHQUFHLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFJakYsT0FBTyxFQUFFLGdCQUFnQixFQUFrQixNQUFNLHFCQUFxQixDQUFDO0FBQ3ZFLE9BQU8sRUFBaUIsaUJBQWlCLEVBQUUsZUFBZSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBRS9FLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQzVELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLDBCQUEwQixDQUFDOzs7Ozs7O0FBaUNoRSxNQUFNLE9BQU8sc0JBQXNCO0lBeUNqQyxZQUFvQixHQUFlLEVBQ2YsR0FBc0IsRUFDdEIsS0FBYSxFQUNiLFNBQW1CLEVBQ25CLGFBQWtDLEVBQ2xDLFFBQWlCO1FBTGpCLFFBQUcsR0FBSCxHQUFHLENBQVk7UUFDZixRQUFHLEdBQUgsR0FBRyxDQUFtQjtRQUN0QixVQUFLLEdBQUwsS0FBSyxDQUFRO1FBQ2IsY0FBUyxHQUFULFNBQVMs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QUFDLENBQUMsUUFBaUQsRUFBRSxFQUFFO1lBQzFFLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLG9CQUFvQixDQUNsRCxDQUFDLE9BQW9DLEVBQUUsRUFBRSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQ2hFLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxDQUNqQixDQUFDO1lBQ0YsT0FBTyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDdEQsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUNMLFFBQVEsQ0FBQyxDQUFDLE9BQW9DLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxFQUMzRCxvQkFBb0IsRUFBRSxDQUN2QixDQUFDO0lBQ0osQ0FBQzs7bUhBbFdVLHNCQUFzQjt1R0FBdEIsc0JBQXNCLDhTQW1DbkIsb0JBQW9CLHFFQXZEeEI7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQWtCVDsyRkFFVSxzQkFBc0I7a0JBdkJsQyxTQUFTO21CQUFDO29CQUNULFFBQVEsRUFBRSxnQkFBZ0I7b0JBQzFCLGVBQWUsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNO29CQUMvQyxRQUFRLEVBQUU7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQWtCVDtpQkFDRjtxT0FvQlUsU0FBUztzQkFBakIsS0FBSztnQkFHRyxLQUFLO3NCQUFiLEtBQUs7Z0JBR0csTUFBTTtzQkFBZCxLQUFLO2dCQUdJLFNBQVM7c0JBQWxCLE1BQU07Z0JBR0csS0FBSztzQkFBZCxNQUFNO2dCQUVnQyxRQUFRO3NCQUE5QyxTQUFTO3VCQUFDLFFBQVEsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUU7Z0JBRUQsS0FBSztzQkFBeEMsWUFBWTt1QkFBQyxvQkFBb0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIENvbXBvbmVudCxcclxuICBJbnB1dCxcclxuICBPdXRwdXQsXHJcbiAgRXZlbnRFbWl0dGVyLFxyXG4gIEFmdGVyVmlld0luaXQsXHJcbiAgQWZ0ZXJWaWV3Q2hlY2tlZCxcclxuICBPbkRlc3Ryb3ksXHJcbiAgT25Jbml0LFxyXG4gIE9uQ2hhbmdlcyxcclxuICBWaWV3Q2hpbGQsXHJcbiAgVmlld0NoaWxkcmVuLFxyXG4gIFNpbXBsZUNoYW5nZXMsXHJcbiAgTmdab25lLFxyXG4gIEVsZW1lbnRSZWYsXHJcbiAgUXVlcnlMaXN0LFxyXG4gIENoYW5nZURldGVjdG9yUmVmLFxyXG4gIENoYW5nZURldGVjdGlvblN0cmF0ZWd5XHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFBsYXRmb3JtIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL3BsYXRmb3JtJztcclxuaW1wb3J0IHtcclxuICBmcm9tLFxyXG4gIGRpc3RpbmN0VW50aWxDaGFuZ2VkLFxyXG4gIGZyb21FdmVudCxcclxuICBtZXJnZU1hcCxcclxuICBzdGFydFdpdGgsXHJcbiAgRU1QVFksXHJcbiAgT2JzZXJ2YWJsZSxcclxuICBTdWJqZWN0LFxyXG4gIFN1YnNjcmliZXIsXHJcbiAgYW5pbWF0aW9uRnJhbWVTY2hlZHVsZXJcclxufSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgdGFwLCBkZWJvdW5jZVRpbWUsIGZpbHRlciwgdGFrZVVudGlsLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEdhbGxlcnkgfSBmcm9tICcuLi9zZXJ2aWNlcy9nYWxsZXJ5LnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBHYWxsZXJ5U3RhdGUsIEdhbGxlcnlFcnJvciB9IGZyb20gJy4uL21vZGVscy9nYWxsZXJ5Lm1vZGVsJztcclxuaW1wb3J0IHsgR2FsbGVyeUNvbmZpZyB9IGZyb20gJy4uL21vZGVscy9jb25maWcubW9kZWwnO1xyXG5pbXBvcnQgeyBTbGlkaW5nRGlyZWN0aW9uLCBUaHVtYm5haWxzVmlldyB9IGZyb20gJy4uL21vZGVscy9jb25zdGFudHMnO1xyXG5pbXBvcnQgeyBTbGlkZXJBZGFwdGVyLCBIb3Jpem9udGFsQWRhcHRlciwgVmVydGljYWxBZGFwdGVyIH0gZnJvbSAnLi9hZGFwdGVycyc7XHJcbmltcG9ydCB7IFNtb290aFNjcm9sbE1hbmFnZXIgfSBmcm9tICcuLi9zbW9vdGgtc2Nyb2xsJztcclxuaW1wb3J0IHsgcmVzaXplT2JzZXJ2YWJsZSB9IGZyb20gJy4uL3V0aWxzL3Jlc2l6ZS1vYnNlcnZlcic7XHJcbmltcG9ydCB7IEdhbGxlcnlJdGVtQ29tcG9uZW50IH0gZnJvbSAnLi9nYWxsZXJ5LWl0ZW0uY29tcG9uZW50JztcclxuXHJcbmludGVyZmFjZSBTY3JvbGxPYnNlcnZlciB7XHJcbiAgdmFsdWU6IG51bWJlcjtcclxuICBiZWhhdmlvcjogU2Nyb2xsQmVoYXZpb3I7XHJcbiAgb25FbmQ6IEZ1bmN0aW9uO1xyXG59XHJcblxyXG5kZWNsYXJlIGNvbnN0IEhhbW1lcjogYW55O1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgc2VsZWN0b3I6ICdnYWxsZXJ5LXNsaWRlcicsXHJcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXHJcbiAgdGVtcGxhdGU6IGBcclxuICAgIDxkaXYgI3NsaWRlclxyXG4gICAgICAgICBjbGFzcz1cImctc2xpZGVyXCJcclxuICAgICAgICAgW2F0dHIuY2VudHJhbGlzZWRdPVwiY29uZmlnLml0ZW1BdXRvc2l6ZVwiPlxyXG4gICAgICA8ZGl2IGNsYXNzPVwiZy1zbGlkZXItY29udGVudFwiPlxyXG4gICAgICAgIDxnYWxsZXJ5LWl0ZW0gKm5nRm9yPVwibGV0IGl0ZW0gb2Ygc3RhdGUuaXRlbXM7IHRyYWNrQnk6IHRyYWNrQnlGbjsgaW5kZXggYXMgaVwiXHJcbiAgICAgICAgICAgICAgICAgICAgICBbYXR0ci5nYWxsZXJ5SWRdPVwiZ2FsbGVyeUlkXCJcclxuICAgICAgICAgICAgICAgICAgICAgIFt0eXBlXT1cIml0ZW0udHlwZVwiXHJcbiAgICAgICAgICAgICAgICAgICAgICBbY29uZmlnXT1cImNvbmZpZ1wiXHJcbiAgICAgICAgICAgICAgICAgICAgICBbZGF0YV09XCJpdGVtLmRhdGFcIlxyXG4gICAgICAgICAgICAgICAgICAgICAgW2N1cnJJbmRleF09XCJzdGF0ZS5jdXJySW5kZXhcIlxyXG4gICAgICAgICAgICAgICAgICAgICAgW2luZGV4XT1cImlcIlxyXG4gICAgICAgICAgICAgICAgICAgICAgKGNsaWNrKT1cIml0ZW1DbGljay5lbWl0KGkpXCJcclxuICAgICAgICAgICAgICAgICAgICAgIChlcnJvcik9XCJlcnJvci5lbWl0KHsgaXRlbUluZGV4OiBpLCBlcnJvcjogJGV2ZW50IH0pXCI+XHJcbiAgICAgICAgPC9nYWxsZXJ5LWl0ZW0+XHJcbiAgICAgIDwvZGl2PlxyXG4gICAgPC9kaXY+XHJcbiAgICA8bmctY29udGVudD48L25nLWNvbnRlbnQ+XHJcbiAgYFxyXG59KVxyXG5leHBvcnQgY2xhc3MgR2FsbGVyeVNsaWRlckNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzLCBBZnRlclZpZXdJbml0LCBBZnRlclZpZXdDaGVja2VkLCBPbkRlc3Ryb3kge1xyXG5cclxuICByZWFkb25seSBzY3JvbGxIYW5kbGVyJDogU3ViamVjdDxTY3JvbGxPYnNlcnZlcj4gPSBuZXcgU3ViamVjdDxTY3JvbGxPYnNlcnZlcj4oKTtcclxuXHJcbiAgLyoqIEhhbW1lckpTIGluc3RhbmNlICovXHJcbiAgcHJpdmF0ZSBfaGFtbWVyOiBhbnk7XHJcblxyXG4gIHByaXZhdGUgaW50ZXJzZWN0aW9uT2JzZXJ2ZXI6IEludGVyc2VjdGlvbk9ic2VydmVyO1xyXG5cclxuICBwcml2YXRlIHZpc2libGVFbGVtZW50czogTWFwPEVsZW1lbnQsIEludGVyc2VjdGlvbk9ic2VydmVyRW50cnk+ID0gbmV3IE1hcDxFbGVtZW50LCBJbnRlcnNlY3Rpb25PYnNlcnZlckVudHJ5PigpO1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IF9kZXN0cm95ZWQkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcclxuXHJcbiAgcHJpdmF0ZSBfaXNQYW5uaW5nOiBib29sZWFuO1xyXG5cclxuICAvKiogU2xpZGVyIGFkYXB0ZXIgKi9cclxuICBhZGFwdGVyOiBTbGlkZXJBZGFwdGVyO1xyXG5cclxuICAvKiogR2FsbGVyeSBJRCAqL1xyXG4gIEBJbnB1dCgpIGdhbGxlcnlJZDogc3RyaW5nO1xyXG5cclxuICAvKiogR2FsbGVyeSBzdGF0ZSAqL1xyXG4gIEBJbnB1dCgpIHN0YXRlOiBHYWxsZXJ5U3RhdGU7XHJcblxyXG4gIC8qKiBHYWxsZXJ5IGNvbmZpZyAqL1xyXG4gIEBJbnB1dCgpIGNvbmZpZzogR2FsbGVyeUNvbmZpZztcclxuXHJcbiAgLyoqIFN0cmVhbSB0aGF0IGVtaXRzIHdoZW4gaXRlbSBpcyBjbGlja2VkICovXHJcbiAgQE91dHB1dCgpIGl0ZW1DbGljayA9IG5ldyBFdmVudEVtaXR0ZXI8bnVtYmVyPigpO1xyXG5cclxuICAvKiogU3RyZWFtIHRoYXQgZW1pdHMgd2hlbiBhbiBlcnJvciBvY2N1cnMgKi9cclxuICBAT3V0cHV0KCkgZXJyb3IgPSBuZXcgRXZlbnRFbWl0dGVyPEdhbGxlcnlFcnJvcj4oKTtcclxuXHJcbiAgQFZpZXdDaGlsZCgnc2xpZGVyJywgeyBzdGF0aWM6IHRydWUgfSkgc2xpZGVyRWw6IEVsZW1lbnRSZWY7XHJcblxyXG4gIEBWaWV3Q2hpbGRyZW4oR2FsbGVyeUl0ZW1Db21wb25lbnQpIGl0ZW1zID0gbmV3IFF1ZXJ5TGlzdDxHYWxsZXJ5SXRlbUNvbXBvbmVudD4oKTtcclxuXHJcbiAgZ2V0IHNsaWRlcigpOiBIVE1MRWxlbWVudCB7XHJcbiAgICByZXR1cm4gdGhpcy5zbGlkZXJFbC5uYXRpdmVFbGVtZW50O1xyXG4gIH1cclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBfZWw6IEVsZW1lbnRSZWYsXHJcbiAgICAgICAgICAgICAgcHJpdmF0ZSBfY2Q6IENoYW5nZURldGVjdG9yUmVmLFxyXG4gICAgICAgICAgICAgIHByaXZhdGUgX3pvbmU6IE5nWm9uZSxcclxuICAgICAgICAgICAgICBwcml2YXRlIF9wbGF0Zm9ybTogUGxhdGZvcm0sXHJcbiAgICAgICAgICAgICAgcHJpdmF0ZSBfc21vb3RoU2Nyb2xsOiBTbW9vdGhTY3JvbGxNYW5hZ2VyLFxyXG4gICAgICAgICAgICAgIHByaXZhdGUgX2dhbGxlcnk6IEdhbGxlcnkpIHtcclxuXHJcbiAgICB0aGlzLnNjcm9sbEhhbmRsZXIkLnBpcGUoXHJcbiAgICAgIGRlYm91bmNlVGltZSgwLCBhbmltYXRpb25GcmFtZVNjaGVkdWxlciksXHJcbiAgICAgIHN3aXRjaE1hcCgoeyB2YWx1ZSwgYmVoYXZpb3IgfTogU2Nyb2xsT2JzZXJ2ZXIpID0+IHtcclxuICAgICAgICB0aGlzLl9nYWxsZXJ5LmRlYnVnQ29uc29sZSgnW0dhbGxlcnkgc2Nyb2xsSGFuZGxlciRdICcsIHRoaXMuc2xpZGVyLnN0eWxlLnNjcm9sbFNuYXBUeXBlKTtcclxuICAgICAgICB0aGlzLnNsaWRlci5zdHlsZS5zY3JvbGxTbmFwVHlwZSA9ICd1bnNldCc7XHJcbiAgICAgICAgY29uc3QgZWw6IEhUTUxFbGVtZW50ID0gdGhpcy5pdGVtcy5nZXQodmFsdWUpPy5lbGVtZW50O1xyXG5cclxuICAgICAgICB0aGlzLl9nYWxsZXJ5LmRlYnVnQ29uc29sZSgn8J+kryBbR2FsbGVyeSBzY3JvbGxIYW5kbGVyJF0gc2Nyb2xsU25hcFR5cGUgPSB1bnNldCwgc2Nyb2xsVG8gZWxlbWVudCcsICEhZWwpO1xyXG4gICAgICAgIGlmIChlbCkge1xyXG4gICAgICAgICAgdGhpcy5zbGlkZXIuY2xhc3NMaXN0LmFkZCgnZy1zY3JvbGxpbmcnKTtcclxuICAgICAgICAgIGNvbnN0IHBvcyA9IHRoaXMuYWRhcHRlci5nZXRTY3JvbGxUb1ZhbHVlKGVsLCBiZWhhdmlvciB8fCB0aGlzLmNvbmZpZy5zY3JvbGxCZWhhdmlvcik7XHJcbiAgICAgICAgICBjb25zdCBpbmRleDogbnVtYmVyID0gK3RoaXMuaXRlbXMuZ2V0KHZhbHVlKT8uZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2dhbGxlcnlJbmRleCcpO1xyXG4gICAgICAgICAgdGhpcy5fZ2FsbGVyeS5kZWJ1Z0NvbnNvbGUoYPCfmoAgW0dhbGxlcnkgc2Nyb2xsSGFuZGxlciRdIFNjcm9sbCBzdGFydCA9PT0+IGluZGV4OiAkeyBpbmRleCB9LCBwb3NpdGlvbjpgLCBwb3MpO1xyXG4gICAgICAgICAgdGhpcy5fZ2FsbGVyeS5kZWJ1Z0NvbnNvbGUoYPCfmoAgW0dhbGxlcnkgc2Nyb2xsSGFuZGxlciRdIHNsaWRlciBzY3JvbGxhYmxlYCwgdGhpcy5hZGFwdGVyLnNjcm9sbFZhbHVlKTtcclxuXHJcbiAgICAgICAgICByZXR1cm4gZnJvbSh0aGlzLl9zbW9vdGhTY3JvbGwuc2Nyb2xsVG8odGhpcy5zbGlkZXIsIHBvcykpLnBpcGUoXHJcbiAgICAgICAgICAgIHRhcCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgLy8gUmVzZXQgdmlld3BvcnQgcHJvcGVydGllcyBvbiBzY3JvbGwgZW5kXHJcbiAgICAgICAgICAgICAgdGhpcy5faXNQYW5uaW5nID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgdGhpcy5zbGlkZXIuY2xhc3NMaXN0LnJlbW92ZSgnZy1zY3JvbGxpbmcnKTtcclxuICAgICAgICAgICAgICB0aGlzLnNsaWRlci5zdHlsZS5zY3JvbGxTbmFwVHlwZSA9IHRoaXMuYWRhcHRlci5zY3JvbGxTbmFwVHlwZTtcclxuICAgICAgICAgICAgICB0aGlzLl9nYWxsZXJ5LmRlYnVnQ29uc29sZSgn4pyFIFtHYWxsZXJ5IHNjcm9sbEhhbmRsZXIkXSBTY3JvbGwgZW5kJyk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLl9nYWxsZXJ5LmRlYnVnQ29uc29sZSgn8J+YoSBbR2FsbGVyeSBzY3JvbGxIYW5kbGVyJF0gU2Nyb2xsIGVsZW1lbnQgd2FzIG5vdCBmb3VuZCEnKTtcclxuICAgICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICAgIH0pLFxyXG4gICAgICB0YWtlVW50aWwodGhpcy5fZGVzdHJveWVkJClcclxuICAgICkuc3Vic2NyaWJlKCk7XHJcbiAgfVxyXG5cclxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XHJcbiAgICBpZiAoY2hhbmdlcy5jb25maWcpIHtcclxuICAgICAgaWYgKGNoYW5nZXMuY29uZmlnLmN1cnJlbnRWYWx1ZT8uc2xpZGluZ0RpcmVjdGlvbiAhPT0gY2hhbmdlcy5jb25maWcucHJldmlvdXNWYWx1ZT8uc2xpZGluZ0RpcmVjdGlvbikge1xyXG4gICAgICAgIHN3aXRjaCAodGhpcy5jb25maWcuc2xpZGluZ0RpcmVjdGlvbikge1xyXG4gICAgICAgICAgY2FzZSBTbGlkaW5nRGlyZWN0aW9uLkhvcml6b250YWw6XHJcbiAgICAgICAgICAgIHRoaXMuYWRhcHRlciA9IG5ldyBIb3Jpem9udGFsQWRhcHRlcih0aGlzLnNsaWRlciwgdGhpcy5jb25maWcpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgIGNhc2UgU2xpZGluZ0RpcmVjdGlvbi5WZXJ0aWNhbDpcclxuICAgICAgICAgICAgdGhpcy5hZGFwdGVyID0gbmV3IFZlcnRpY2FsQWRhcHRlcih0aGlzLnNsaWRlciwgdGhpcy5jb25maWcpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICghY2hhbmdlcy5jb25maWcuZmlyc3RDaGFuZ2UpIHtcclxuICAgICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XHJcbiAgICAgICAgICAgIC8vIEtlZXAgdGhlIGNvcnJlY3Qgc2xpZGluZyBwb3NpdGlvbiB3aGVuIGRpcmVjdGlvbiBjaGFuZ2VzXHJcbiAgICAgICAgICAgIHRoaXMuc2Nyb2xsVG9JbmRleCh0aGlzLnN0YXRlLmN1cnJJbmRleCwgJ2F1dG8nKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gUmVhY3RpdmF0ZSBnZXN0dXJlc1xyXG4gICAgICAgIHRoaXMuZW5hYmxlRGlzYWJsZUdlc3R1cmVzKCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGlmICghY2hhbmdlcy5jb25maWcuZmlyc3RDaGFuZ2UpIHtcclxuICAgICAgICBpZiAoY2hhbmdlcy5jb25maWcuY3VycmVudFZhbHVlPy5tb3VzZVNsaWRpbmdEaXNhYmxlZCAhPT0gY2hhbmdlcy5jb25maWcucHJldmlvdXNWYWx1ZT8ubW91c2VTbGlkaW5nRGlzYWJsZWQpIHtcclxuICAgICAgICAgIHRoaXMuZW5hYmxlRGlzYWJsZUdlc3R1cmVzKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gU2Nyb2xsIHRvIGN1cnJlbnQgaW5kZXhcclxuICAgIGlmIChjaGFuZ2VzLnN0YXRlICYmIGNoYW5nZXMuc3RhdGUuY3VycmVudFZhbHVlPy5jdXJySW5kZXggIT09IGNoYW5nZXMuc3RhdGUucHJldmlvdXNWYWx1ZT8uY3VyckluZGV4KSB7XHJcbiAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5zY3JvbGxUb0luZGV4KHRoaXMuc3RhdGUuY3VyckluZGV4LCBjaGFuZ2VzLnN0YXRlLmZpcnN0Q2hhbmdlID8gJ2F1dG8nIDogdGhpcy5zdGF0ZS5iZWhhdmlvcik7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICB0aGlzLl96b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcclxuXHJcbiAgICAgIC8vIFdlIG5lZWQgdG8gc2V0IHRoZSB2aXNpYmxlRWxlbWVudHMgaW4gdGhlIHZpZXdwb3J0IHVzaW5nIGludGVyc2VjdGlvbiBvYnNlcnZlclxyXG4gICAgICB0aGlzLmNyZWF0ZUludGVyc2VjdGlvbk9ic2VydmVyKHRoaXMuc2xpZGVyKS5waXBlKFxyXG4gICAgICAgIHRhcCgoZW50cnk6IEludGVyc2VjdGlvbk9ic2VydmVyRW50cnkpID0+IHtcclxuICAgICAgICAgIGVudHJ5LnRhcmdldC5jbGFzc0xpc3QudG9nZ2xlKCdnLWl0ZW0tdmlzaWJsZScsIGVudHJ5LmlzSW50ZXJzZWN0aW5nKTtcclxuICAgICAgICAgIGlmIChlbnRyeS5pc0ludGVyc2VjdGluZykge1xyXG4gICAgICAgICAgICB0aGlzLnZpc2libGVFbGVtZW50cy5zZXQoZW50cnkudGFyZ2V0LCBlbnRyeSk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnZpc2libGVFbGVtZW50cy5kZWxldGUoZW50cnkudGFyZ2V0KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KSxcclxuICAgICAgICB0YWtlVW50aWwodGhpcy5fZGVzdHJveWVkJClcclxuICAgICAgKS5zdWJzY3JpYmUoKTtcclxuXHJcbiAgICAgIC8vIFN1YnNjcmliZSB0byBzbGlkZXIgc2Nyb2xsIGV2ZW50XHJcbiAgICAgIGZyb21FdmVudCh0aGlzLnNsaWRlciwgJ3Njcm9sbCcsIHsgcGFzc2l2ZTogdHJ1ZSB9KS5waXBlKFxyXG4gICAgICAgIGRlYm91bmNlVGltZSg1MCksXHJcbiAgICAgICAgZmlsdGVyKCgpID0+ICF0aGlzLl9pc1Bhbm5pbmcpLFxyXG4gICAgICAgIHRhcCgoKSA9PiB0aGlzLm9uVmlld3BvcnRTY3JvbGwoKSksXHJcbiAgICAgICAgdGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3llZCQpXHJcbiAgICAgICkuc3Vic2NyaWJlKCk7XHJcblxyXG4gICAgICAvLyBEZXRlY3QgaWYgdGhlIHNpemUgb2YgdGhlIHNsaWRlciBoYXMgY2hhbmdlZCBkZXRlY3RpbmcgY3VycmVudCBpbmRleCBvbiBzY3JvbGxcclxuICAgICAgaWYgKHRoaXMuX3BsYXRmb3JtLmlzQnJvd3Nlcikge1xyXG4gICAgICAgIHJlc2l6ZU9ic2VydmFibGUodGhpcy5fZWwubmF0aXZlRWxlbWVudCkucGlwZShcclxuICAgICAgICAgIGRlYm91bmNlVGltZSh0aGlzLmNvbmZpZy5yZXNpemVEZWJvdW5jZVRpbWUpLFxyXG4gICAgICAgICAgdGFwKChbZW50cnldOiBSZXNpemVPYnNlcnZlckVudHJ5W10pID0+IHRoaXMub25Ib3N0UmVzaXplKGVudHJ5KSksXHJcbiAgICAgICAgICB0YWtlVW50aWwodGhpcy5fZGVzdHJveWVkJClcclxuICAgICAgICApLnN1YnNjcmliZSgpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcclxuICAgIHRoaXMuaXRlbXMubm90aWZ5T25DaGFuZ2VzKCk7XHJcbiAgICB0aGlzLml0ZW1zLmNoYW5nZXMucGlwZShcclxuICAgICAgc3RhcnRXaXRoKG51bGwpLFxyXG4gICAgICB0YXAoKCkgPT4ge1xyXG4gICAgICAgIC8vIERpc2Nvbm5lY3QgYWxsIGFuZCByZWNvbm5lY3QgbGF0ZXJcclxuICAgICAgICB0aGlzLnZpc2libGVFbGVtZW50cy5mb3JFYWNoKChpdGVtOiBJbnRlcnNlY3Rpb25PYnNlcnZlckVudHJ5KSA9PiB7XHJcbiAgICAgICAgICB0aGlzLmludGVyc2VjdGlvbk9ic2VydmVyLnVub2JzZXJ2ZShpdGVtLnRhcmdldCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIENvbm5lY3Qgd2l0aCB0aGUgbmV3IGl0ZW1zXHJcbiAgICAgICAgdGhpcy5pdGVtcy50b0FycmF5KCkubWFwKChpdGVtOiBHYWxsZXJ5SXRlbUNvbXBvbmVudCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5pbnRlcnNlY3Rpb25PYnNlcnZlci5vYnNlcnZlKGl0ZW0uZWxlbWVudCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pLFxyXG4gICAgICB0YWtlVW50aWwodGhpcy5fZGVzdHJveWVkJClcclxuICAgICkuc3Vic2NyaWJlKCk7XHJcbiAgfVxyXG5cclxuICBuZ0FmdGVyVmlld0NoZWNrZWQoKTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5jb25maWcuaXRlbUF1dG9zaXplKSB7XHJcbiAgICAgIHRoaXMuc2xpZGVyLnN0eWxlLnNldFByb3BlcnR5KCctLXNsaWRlci1jZW50cmFsaXplLXN0YXJ0LXNpemUnLCB0aGlzLmFkYXB0ZXIuZ2V0Q2VudHJhbGl6ZXJTdGFydFNpemUoKSArICdweCcpO1xyXG4gICAgICB0aGlzLnNsaWRlci5zdHlsZS5zZXRQcm9wZXJ0eSgnLS1zbGlkZXItY2VudHJhbGl6ZS1lbmQtc2l6ZScsIHRoaXMuYWRhcHRlci5nZXRDZW50cmFsaXplckVuZFNpemUoKSArICdweCcpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XHJcbiAgICB0aGlzLl9kZXN0cm95ZWQkLm5leHQoKTtcclxuICAgIHRoaXMuX2Rlc3Ryb3llZCQuY29tcGxldGUoKTtcclxuICAgIHRoaXMuZGVhY3RpdmF0ZUdlc3R1cmVzKCk7XHJcbiAgfVxyXG5cclxuICB0cmFja0J5Rm4oaW5kZXg6IG51bWJlciwgaXRlbTogYW55KSB7XHJcbiAgICByZXR1cm4gaXRlbS50eXBlO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBvbkhvc3RSZXNpemUoZW50cnk6IFJlc2l6ZU9ic2VydmVyRW50cnkpOiB2b2lkIHtcclxuICAgIGNvbnN0IHdpZHRoOiBudW1iZXIgPSBNYXRoLmNlaWwoZW50cnkuY29udGVudFJlY3Qud2lkdGgpO1xyXG4gICAgY29uc3QgaGVpZ2h0OiBudW1iZXIgPSBNYXRoLmNlaWwoZW50cnkuY29udGVudFJlY3QuaGVpZ2h0KTtcclxuICAgIHRoaXMuc2xpZGVyLnN0eWxlLndpZHRoID0gYCR7IHdpZHRoIH1weGA7XHJcbiAgICB0aGlzLnNsaWRlci5zdHlsZS5oZWlnaHQgPSBgJHsgaGVpZ2h0IH1weGA7XHJcbiAgICB0aGlzLnNjcm9sbFRvSW5kZXgodGhpcy5zdGF0ZS5jdXJySW5kZXgsICdhdXRvJyk7XHJcbiAgICAvLyBEZXRlY3QgY2hhbmdlcyBvbiBnYWxsZXJ5LWl0ZW0gY29tcG9uZW50cyB0byByZS1jYWxjdWxhdGUgaXRlbSBzaXplXHJcbiAgICB0aGlzLl9jZC5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICB0aGlzLl9nYWxsZXJ5LmRlYnVnQ29uc29sZSgn8J+mkCBbR2FsbGVyeSBPbkhvc3RSZXNpemVdOiBzZXQgdmlld3BvcnQgd2lkdGggdG8gYWJzb2x1dGUgbnVtYmVyJyk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIG9uVmlld3BvcnRTY3JvbGwoKTogdm9pZCB7XHJcbiAgICAvLyBDaGVjayBpZiBzY3JvbGxlZCBpdGVtIGlzIGdyZWF0IGVub3VnaCB0byBuYXZpZ2F0ZVxyXG4gICAgY29uc3QgY3VyckVsZW1lbnQ6IEVsZW1lbnQgPSB0aGlzLml0ZW1zLmdldCh0aGlzLnN0YXRlLmN1cnJJbmRleCk/LmVsZW1lbnQ7XHJcbiAgICBjb25zdCBlbGVtZW50QXRDZW50ZXI6IEVsZW1lbnQgPSB0aGlzLmdldEVsZW1lbnRGcm9tVmlld3BvcnRDZW50ZXIoKTtcclxuXHJcbiAgICBpZiAoZWxlbWVudEF0Q2VudGVyKSB7XHJcbiAgICAgIC8vIENoZWNrIGlmIHRoZSBnYWxsZXJ5LWl0ZW0gZWxlbWVudCBpcyBub3QgdGhlIGFjdGl2ZSBlbGVtZW50XHJcbiAgICAgIGlmIChlbGVtZW50QXRDZW50ZXIgIT09IGN1cnJFbGVtZW50KSB7XHJcbiAgICAgICAgdGhpcy50cnlTY3JvbGxUb0VsZW1lbnQoZWxlbWVudEF0Q2VudGVyIGFzIEhUTUxFbGVtZW50KTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5fZ2FsbGVyeS5kZWJ1Z0NvbnNvbGUoJ+KBiSBbR2FsbGVyeSBvblZpZXdwb3J0U2Nyb2xsXTogTm8gY2VudGVyIGVsZW1lbnQgd2FzIGZvdW5kJyk7XHJcbiAgICAgIHRoaXMudmlzaWJsZUVsZW1lbnRzLmZvckVhY2goKGVudHJ5OiBJbnRlcnNlY3Rpb25PYnNlcnZlckVudHJ5KSA9PiB7XHJcbiAgICAgICAgdGhpcy50cnlTY3JvbGxUb0VsZW1lbnQoZW50cnkudGFyZ2V0IGFzIEhUTUxFbGVtZW50KTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHRyeVNjcm9sbFRvRWxlbWVudChlbGVtZW50QXRDZW50ZXI6IEhUTUxFbGVtZW50KTogdm9pZCB7XHJcbiAgICBjb25zdCBhbGxvd2VkTWFyZ2luOiBudW1iZXIgPSAxMDtcclxuICAgIGNvbnN0IG9mZnNldERpZmY6IG51bWJlciA9ICh0aGlzLmFkYXB0ZXIuY2xpZW50U2l6ZSAtIHRoaXMuYWRhcHRlci5nZXRDbGllbnRTaXplKGVsZW1lbnRBdENlbnRlcikpIC8gMjtcclxuICAgIGNvbnN0IHJhbmdlU3RhcnQ6IG51bWJlciA9IHRoaXMuYWRhcHRlci5zY3JvbGxWYWx1ZSArIG9mZnNldERpZmY7XHJcbiAgICBjb25zdCByYW5nZUVuZDogbnVtYmVyID0gdGhpcy5hZGFwdGVyLnNjcm9sbFZhbHVlICsgdGhpcy5hZGFwdGVyLmNsaWVudFNpemUgLSBvZmZzZXREaWZmO1xyXG4gICAgY29uc3QgZWxTdGFydDogbnVtYmVyID0gdGhpcy5hZGFwdGVyLmdldE9mZnNldFNpemUoZWxlbWVudEF0Q2VudGVyKTtcclxuICAgIGNvbnN0IGVsRW5kOiBudW1iZXIgPSBlbFN0YXJ0ICsgdGhpcy5hZGFwdGVyLmdldENsaWVudFNpemUoZWxlbWVudEF0Q2VudGVyKTtcclxuXHJcbiAgICBjb25zdCBpc1N0YXJ0OiBib29sZWFuID0gcmFuZ2VTdGFydCArIGFsbG93ZWRNYXJnaW4gPj0gZWxTdGFydCAmJiByYW5nZVN0YXJ0IC0gYWxsb3dlZE1hcmdpbiA8PSBlbFN0YXJ0O1xyXG4gICAgY29uc3QgaXNFbmQ6IGJvb2xlYW4gPSByYW5nZUVuZCArIGFsbG93ZWRNYXJnaW4gPj0gZWxFbmQgJiYgcmFuZ2VFbmQgLSBhbGxvd2VkTWFyZ2luIDw9IGVsRW5kO1xyXG5cclxuICAgIC8vIFJlc2V0IHBvc2l0aW9uXHJcbiAgICB0aGlzLnNsaWRlci5zdHlsZS5zY3JvbGxTbmFwVHlwZSA9IHRoaXMuYWRhcHRlci5zY3JvbGxTbmFwVHlwZTtcclxuXHJcbiAgICAvLyBDaGVjayBpZiBlbGVtZW50IGlzIHdpdGhpbiB0aGUgZGV0ZWN0aW9uIHJhbmdlXHJcbiAgICBpZiAoaXNTdGFydCAmJiBpc0VuZCkge1xyXG4gICAgICAvLyBJZiBlbGVtZW50IGlzIHdpdGhpbiB0aGUgcmFuZ2Ugc2V0IGl0IGFzIHRoZSBhY3RpdmUgZ2FsbGVyeSBpdGVtXHJcbiAgICAgIHRoaXMuX2dhbGxlcnkuZGVidWdDb25zb2xlKCfwn42EIFtHYWxsZXJ5IG9uVmlld3BvcnRTY3JvbGxdOiBTZXQgYWN0aXZlIGdhbGxlcnkgaXRlbScpO1xyXG5cclxuICAgICAgY29uc3QgaW5kZXg6IG51bWJlciA9ICtlbGVtZW50QXRDZW50ZXIuZ2V0QXR0cmlidXRlKCdnYWxsZXJ5SW5kZXgnKTtcclxuICAgICAgdGhpcy5fem9uZS5ydW4oKCkgPT4gdGhpcy5fZ2FsbGVyeS5yZWYodGhpcy5nYWxsZXJ5SWQpLnNldChpbmRleCwgJ3Ntb290aCcpKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgc2Nyb2xsVG9JbmRleCh2YWx1ZTogbnVtYmVyLCBiZWhhdmlvcjogU2Nyb2xsQmVoYXZpb3IsIG9uRW5kPzogKCkgPT4gdm9pZCk6IHZvaWQge1xyXG4gICAgdGhpcy5zY3JvbGxIYW5kbGVyJC5uZXh0KHsgdmFsdWUsIGJlaGF2aW9yLCBvbkVuZCB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZW5hYmxlRGlzYWJsZUdlc3R1cmVzKCk6IHZvaWQge1xyXG4gICAgLy8gRW5hYmxlL0Rpc2FibGUgbW91c2Ugc2xpZGluZyBvbiBkZXNrdG9wIGJyb3dzZXIgb25seVxyXG4gICAgaWYgKCF0aGlzLl9wbGF0Zm9ybS5JT1MgJiYgIXRoaXMuX3BsYXRmb3JtLkFORFJPSUQpIHtcclxuICAgICAgaWYgKCF0aGlzLmNvbmZpZy5tb3VzZVNsaWRpbmdEaXNhYmxlZCkge1xyXG4gICAgICAgIHRoaXMuYWN0aXZhdGVHZXN0dXJlcygpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMuZGVhY3RpdmF0ZUdlc3R1cmVzKCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgYWN0aXZhdGVHZXN0dXJlcygpOiB2b2lkIHtcclxuICAgIGlmICh0eXBlb2YgSGFtbWVyICE9PSAndW5kZWZpbmVkJykge1xyXG4gICAgICAvLyBEZXN0cm95IGhhbW1lciBpZiBhIHByZXZpb3VzIGluc3RhbmNlIHdhcyBjcmVhdGVkXHJcbiAgICAgIHRoaXMuZGVhY3RpdmF0ZUdlc3R1cmVzKCk7XHJcblxyXG4gICAgICBjb25zdCBkaXJlY3Rpb246IG51bWJlciA9IHRoaXMuYWRhcHRlci5wYW5EaXJlY3Rpb247XHJcblxyXG4gICAgICAvLyBBY3RpdmF0ZSBnZXN0dXJlc1xyXG4gICAgICB0aGlzLl96b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcclxuICAgICAgICB0aGlzLl9oYW1tZXIgPSBuZXcgSGFtbWVyKHRoaXMuX2VsLm5hdGl2ZUVsZW1lbnQsIHsgaW5wdXRDbGFzczogSGFtbWVyLk1vdXNlSW5wdXQgfSk7XHJcbiAgICAgICAgdGhpcy5faGFtbWVyLmdldCgncGFuJykuc2V0KHsgZGlyZWN0aW9uIH0pO1xyXG5cclxuICAgICAgICBsZXQgcGFuT2Zmc2V0OiBudW1iZXI7XHJcblxyXG4gICAgICAgIC8vIFNldCBwYW5PZmZzZXQgZm9yIHNsaWRpbmcgb24gcGFuIHN0YXJ0IGV2ZW50XHJcbiAgICAgICAgdGhpcy5faGFtbWVyLm9uKCdwYW5zdGFydCcsICgpID0+IHtcclxuICAgICAgICAgIHRoaXMuX3Ntb290aFNjcm9sbC5kaXNtaXNzT25nb2luZ1Njcm9sbCh0aGlzLnNsaWRlcik7XHJcbiAgICAgICAgICBwYW5PZmZzZXQgPSB0aGlzLmFkYXB0ZXIuc2Nyb2xsVmFsdWU7XHJcbiAgICAgICAgICAvLyBEaXNhYmxlIHNjcm9sbC1zbmFwLXR5cGUgZnVuY3Rpb25hbGl0eVxyXG4gICAgICAgICAgdGhpcy5zbGlkZXIuc3R5bGUuc2Nyb2xsU25hcFR5cGUgPSAndW5zZXQnO1xyXG4gICAgICAgICAgdGhpcy5zbGlkZXIuY2xhc3NMaXN0LmFkZCgnZy1zbGlkaW5nJyk7XHJcbiAgICAgICAgICB0aGlzLl9pc1Bhbm5pbmcgPSB0cnVlO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLl9oYW1tZXIub24oJ3Bhbm1vdmUnLCAoZTogYW55KSA9PiB0aGlzLnNsaWRlci5zY3JvbGxUbyh0aGlzLmFkYXB0ZXIuZ2V0UGFuVmFsdWUocGFuT2Zmc2V0LCBlLCAnYXV0bycpKSk7XHJcblxyXG4gICAgICAgIHRoaXMuX2hhbW1lci5vbigncGFuZW5kJywgKGU6IGFueSkgPT4gdGhpcy5vblBhbkVuZChlKSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBkZWFjdGl2YXRlR2VzdHVyZXMoKTogdm9pZCB7XHJcbiAgICB0aGlzLl9oYW1tZXI/LmRlc3Ryb3koKTtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBvblBhbkVuZChlKTogdm9pZCB7XHJcblxyXG4gICAgdGhpcy5fZ2FsbGVyeS5kZWJ1Z0NvbnNvbGUoJ/CflrHvuI8gW0dhbGxlcnldOiBvblBhbkVuZCcsIGUpO1xyXG5cclxuICAgIHRoaXMuc2xpZGVyLmNsYXNzTGlzdC5yZW1vdmUoJ2ctc2xpZGluZycpO1xyXG4gICAgY29uc3QgZGVsdGE6IG51bWJlciA9IHRoaXMuYWRhcHRlci5nZXRQYW5EZWx0YShlKTtcclxuICAgIGNvbnN0IHZlbG9jaXR5OiBudW1iZXIgPSB0aGlzLmFkYXB0ZXIuZ2V0UGFuVmVsb2NpdHkoZSk7XHJcblxyXG4gICAgY29uc3QgZ2FsbGVyeVJlZiA9IHRoaXMuX2dhbGxlcnkucmVmKHRoaXMuZ2FsbGVyeUlkKTtcclxuXHJcbiAgICB0aGlzLl96b25lLnJ1bigoKSA9PiB7XHJcbiAgICAgIC8vIENoZWNrIGlmIHNjcm9sbGVkIGl0ZW0gaXMgZ3JlYXQgZW5vdWdoIHRvIG5hdmlnYXRlXHJcbiAgICAgIGNvbnN0IGN1cnJFbGVtZW50OiBFbGVtZW50ID0gdGhpcy5pdGVtcy5nZXQodGhpcy5zdGF0ZS5jdXJySW5kZXgpPy5lbGVtZW50O1xyXG5cclxuICAgICAgLy8gRmluZCB0aGUgZ2FsbGVyeSBpdGVtIGVsZW1lbnQgaW4gdGhlIGNlbnRlciBlbGVtZW50c1xyXG4gICAgICBjb25zdCBlbGVtZW50QXRDZW50ZXI6IEVsZW1lbnQgPSB0aGlzLmdldEVsZW1lbnRGcm9tVmlld3BvcnRDZW50ZXIoKTtcclxuXHJcbiAgICAgIC8vIENoZWNrIGlmIGNlbnRlciBpdGVtIGNhbiBiZSB0YWtlbiBmcm9tIGVsZW1lbnQgdXNpbmdcclxuICAgICAgaWYgKGVsZW1lbnRBdENlbnRlciAmJiBlbGVtZW50QXRDZW50ZXIgIT09IGN1cnJFbGVtZW50KSB7XHJcbiAgICAgICAgY29uc3QgaW5kZXg6IG51bWJlciA9ICtlbGVtZW50QXRDZW50ZXIuZ2V0QXR0cmlidXRlKCdnYWxsZXJ5SW5kZXgnKTtcclxuICAgICAgICB0aGlzLnNjcm9sbFRvSW5kZXgoaW5kZXgsICdzbW9vdGgnKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIENoZWNrIGlmIGRlbHRhIGlzIGdyZWF0IGVub3VnaCB0byBuYXZpZ2F0ZVxyXG4gICAgICBpZiAoTWF0aC5hYnMoZGVsdGEpID4gKGN1cnJFbGVtZW50LmNsaWVudFdpZHRoIHx8IHRoaXMuYWRhcHRlci5jbGllbnRTaXplKSAvIDIpIHtcclxuICAgICAgICByZXR1cm4gZGVsdGEgPiAwID8gZ2FsbGVyeVJlZi5wcmV2KCdzbW9vdGgnLCBmYWxzZSkgOiBnYWxsZXJ5UmVmLm5leHQoJ3Ntb290aCcsIGZhbHNlKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gQ2hlY2sgaWYgdmVsb2NpdHkgaXMgZ3JlYXQgZW5vdWdoIHRvIG5hdmlnYXRlXHJcbiAgICAgIGlmIChNYXRoLmFicyh2ZWxvY2l0eSkgPiAwLjMpIHtcclxuICAgICAgICByZXR1cm4gdmVsb2NpdHkgPiAwID8gZ2FsbGVyeVJlZi5wcmV2KCdzbW9vdGgnLCBmYWxzZSkgOiBnYWxsZXJ5UmVmLm5leHQoJ3Ntb290aCcsIGZhbHNlKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gUmVzZXQgcG9zaXRpb24gdG8gdGhlIGN1cnJlbnQgaW5kZXhcclxuICAgICAgdGhpcy5zY3JvbGxUb0luZGV4KHRoaXMuc3RhdGUuY3VyckluZGV4LCAnc21vb3RoJyk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0RWxlbWVudEZyb21WaWV3cG9ydENlbnRlcigpOiBFbGVtZW50IHtcclxuICAgIC8vIEdldCBzbGlkZXIgcG9zaXRpb24gcmVsYXRpdmUgdG8gdGhlIGRvY3VtZW50XHJcbiAgICBjb25zdCBzbGlkZXJSZWN0ID0gdGhpcy5zbGlkZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICAvLyBUcnkgbG9vayBmb3IgdGhlIGNlbnRlciBpdGVtIHVzaW5nIGBlbGVtZW50c0Zyb21Qb2ludGAgZnVuY3Rpb25cclxuICAgIGNvbnN0IGNlbnRlckVsZW1lbnRzID0gZG9jdW1lbnQuZWxlbWVudHNGcm9tUG9pbnQoc2xpZGVyUmVjdC54ICsgKHNsaWRlclJlY3Qud2lkdGggLyAyKSwgc2xpZGVyUmVjdC55ICsgKHNsaWRlclJlY3QuaGVpZ2h0IC8gMikpO1xyXG4gICAgLy8gRmluZCB0aGUgZ2FsbGVyeSBpdGVtIGVsZW1lbnQgaW4gdGhlIGNlbnRlciBlbGVtZW50c1xyXG4gICAgY29uc3QgZWxlbWVudCA9IGNlbnRlckVsZW1lbnRzLmZpbmQoKGVsZW1lbnQ6IEVsZW1lbnQpID0+IGVsZW1lbnQubG9jYWxOYW1lID09PSAnZ2FsbGVyeS1pdGVtJyAmJiBlbGVtZW50LmdldEF0dHJpYnV0ZSgnZ2FsbGVyeUlkJykgPT09IHRoaXMuZ2FsbGVyeUlkKTtcclxuXHJcbiAgICB0aGlzLl9nYWxsZXJ5LmRlYnVnQ29uc29sZSgn8J+qnyBbR2FsbGVyeV06IGdldEVsZW1lbnRGcm9tVmlld3BvcnRDZW50ZXInLCBlbGVtZW50KTtcclxuICAgIHJldHVybiBlbGVtZW50O1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjcmVhdGVJbnRlcnNlY3Rpb25PYnNlcnZlcihzbGlkZXI6IEhUTUxFbGVtZW50KTogT2JzZXJ2YWJsZTxJbnRlcnNlY3Rpb25PYnNlcnZlckVudHJ5PiB7XHJcbiAgICByZXR1cm4gbmV3IE9ic2VydmFibGUoKG9ic2VydmVyOiBTdWJzY3JpYmVyPEludGVyc2VjdGlvbk9ic2VydmVyRW50cnlbXT4pID0+IHtcclxuICAgICAgdGhpcy5pbnRlcnNlY3Rpb25PYnNlcnZlciA9IG5ldyBJbnRlcnNlY3Rpb25PYnNlcnZlcihcclxuICAgICAgICAoZW50cmllczogSW50ZXJzZWN0aW9uT2JzZXJ2ZXJFbnRyeVtdKSA9PiBvYnNlcnZlci5uZXh0KGVudHJpZXMpLFxyXG4gICAgICAgIHsgcm9vdDogc2xpZGVyIH1cclxuICAgICAgKTtcclxuICAgICAgcmV0dXJuICgpID0+IHRoaXMuaW50ZXJzZWN0aW9uT2JzZXJ2ZXIuZGlzY29ubmVjdCgpO1xyXG4gICAgfSkucGlwZShcclxuICAgICAgbWVyZ2VNYXAoKGVudHJpZXM6IEludGVyc2VjdGlvbk9ic2VydmVyRW50cnlbXSkgPT4gZW50cmllcyksXHJcbiAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksXHJcbiAgICApO1xyXG4gIH1cclxufVxyXG4iXX0=